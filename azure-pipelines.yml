trigger: [ '*' ]

jobs:
-
    job: 'Python3'
    displayName: 'Pytest Conda'
    pool:
        vmImage: 'ubuntu-latest'

    variables:
        RUNNING_ON_AZURE: 1

    steps:
    -
        script: |
            set -e
            CONDA_ENVIRONMENT=.test-conda-env-py3.yml
            curl -L -O -k https://gitlab.tiker.net/inducer/ci-support/raw/master/build-and-test-py-project-within-miniconda.sh
            . ./build-and-test-py-project-within-miniconda.sh

    -
        task: PublishTestResults@2
        inputs:
            testResultsFormat: 'JUnit'
            testResultsFiles: 'test/pytest.xml'

-
    job: 'Python3_Distributed'
    displayName: 'Distributed Pytest Conda'
    pool:
        vmImage: 'ubuntu-latest'

    variables:
        RUNNING_ON_AZURE: 1

    steps:
    -
        script: |
            set -e
            CONDA_ENVIRONMENT=.test-conda-env-py3.yml
            curl -L -O -k https://gitlab.tiker.net/inducer/ci-support/raw/master/build-py-project-within-miniconda.sh
            . ./build-py-project-within-miniconda.sh
            mpiexec --oversubscribe -np 4 pytest --proc_shape 2,2,1 -rw --durations=10 --tb=native -rxs

-
    job: 'Flake8'
    displayName: 'Flake8'
    pool:
        vmImage: 'ubuntu-latest'
    strategy:
        matrix:
            Python37:
                python.version: '3.7'

    steps:
    -
        task: UsePythonVersion@0
        inputs:
            versionSpec: '$(python.version)'

    -
        script: |
            pip install flake8
            flake8 pystella examples/*.py test/*.py

-
    job: 'Pylint'
    displayName: 'Pylint'
    pool:
        vmImage: 'ubuntu-latest'

    steps:
    -
        script: |
            set -e
            CONDA_ENVIRONMENT=.test-conda-env-py3.yml
            USE_CONDA_BUILD=1
            curl -L -O -k https://gitlab.tiker.net/inducer/ci-support/raw/master/prepare-and-run-pylint.sh
            . ./prepare-and-run-pylint.sh pystella test/test_*.py examples/*.py
